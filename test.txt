#include <stdlib.h>
#include <strings.h>
#include <stdio.h>
#include <stdbool.h>
#include <unistd.h>
#include <sys/ioctl.h>

void clear_screen()
{
	const char *CLEAR_SCREEN_ANSI = "\x1B[1;1H\x1B[2J";
	write(STDOUT_FILENO, CLEAR_SCREEN_ANSI, 12);
}

struct buffer {
	struct line* first;
	int curr; //Current line
};

struct line {
	char val[100];
	struct line* cont;
	struct line* next;
};

struct buffer load_buffer(FILE* fp){
	struct buffer buf;
	struct line* curr_line;
	struct line* cont_parent_line;
	int tmp, i = 0;
	bool cont = false;
	buf.first = malloc(sizeof(struct line));
	buf.curr = 0;
	curr_line = buf.first;
	curr_line->cont = NULL;
	curr_line->next = NULL;
	do {
		tmp = fgetc(fp);
		if (tmp == '\n') {
			if (cont){
				curr_line = cont_parent_line;
				cont = false;
			}
			curr_line->next = malloc(sizeof(struct line));
			curr_line = curr_line->next;
			curr_line->cont = NULL;
			curr_line->next = NULL;
			i = 0;
		} else if (i >= 100) {
			curr_line->cont = malloc(sizeof(struct line));
			if (!cont){
				cont = true;
				cont_parent_line = curr_line;
			}
			curr_line = curr_line->cont;
			curr_line->cont = NULL;
			curr_line->next = NULL;
			i = 0;
		} else {
			curr_line->val[i++] = (char) tmp;	
		}
	} while(tmp != EOF);
	return buf;
}

void print_buf(struct buffer buf, int line_num){
	int i;
	struct line* curr_line, * cont_line;
	curr_line = buf.first;
	for(i = 0; i < line_num && curr_line->next != NULL; i++){
		printf("%s", curr_line);
		while (curr_line->cont != NULL){
			cont_line = curr_line->cont;
			printf("%s", cont_line);
		}
		curr_line = curr_line->next;
		putchar('\n');
	}
}


int main()
{
	struct winsize w;
	int tmp;
	struct buffer buf;

	/* Load file */
	FILE * fp = fopen("test.txt", "r");
	if (fp == NULL){
		fprintf(stderr, "Couldn't read the file");
		exit(1);
	}
	/* Clear screen and get terminal size */
	clear_screen();
	ioctl(STDOUT_FILENO, TIOCGWINSZ, &w);
		
	/* Load buffer */
	buf = load_buffer(fp);

	/* Print content of buffer */
	print_buf(buf, w.ws_row);
}
